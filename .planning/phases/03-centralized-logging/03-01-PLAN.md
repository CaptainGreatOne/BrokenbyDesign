---
phase: 03-centralized-logging
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - services/web-gateway/src/logger.js
  - services/web-gateway/src/server.js
  - services/web-gateway/src/routes.js
  - services/web-gateway/src/grpc-client.js
  - services/web-gateway/src/redis-client.js
autonomous: true

must_haves:
  truths:
    - "web-gateway outputs plain text logs (not JSON) to stdout"
    - "Every log line includes timestamp, level, service name, handler, request/order ID, and message"
    - "web-gateway occasionally emits realistic WARN and ERROR logs during normal operation"
  artifacts:
    - path: "services/web-gateway/src/logger.js"
      provides: "Plain text log formatter with handler/ID extraction"
      contains: "function log"
  key_links:
    - from: "services/web-gateway/src/routes.js"
      to: "services/web-gateway/src/logger.js"
      via: "logger.info/warn/error calls with handler metadata"
      pattern: "handler:"
---

<objective>
Rewrite web-gateway logging from JSON to plain text format and add realistic error patterns.

Purpose: Services must emit plain text logs in the format `[timestamp] [level] [service] [handler] [id] [details] message` so Loki can collect human-readable, filterable logs. Realistic error patterns give the learner real WARN/ERROR entries to discover in Grafana Explore from day one.

Output: Updated logger.js with plain text formatting. All callers updated with consistent `handler` metadata. Occasional simulated timeouts and connection hiccups in request handlers.
</objective>

<execution_context>
@/home/user/.claude/get-shit-done/workflows/execute-plan.md
@/home/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-centralized-logging/03-RESEARCH.md
@services/web-gateway/src/logger.js
@services/web-gateway/src/server.js
@services/web-gateway/src/routes.js
@services/web-gateway/src/grpc-client.js
@services/web-gateway/src/redis-client.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite logger.js to plain text format</name>
  <files>services/web-gateway/src/logger.js</files>
  <action>
Replace the JSON logger with a plain text formatter. The log format must be:

```
{timestamp} {LEVEL} web-gateway {handler} {id} {key=value pairs} {message}
```

The `log(level, message, metadata)` function signature stays the same for backward compatibility. Internally:

1. Extract `handler` from metadata (default to empty string if not present)
2. Extract ID fields: check for `order_id`, `req_id`, `correlation_id` in that priority order (use the first found, format as `order={value}` or `req={value}` or `corr={value}`)
3. Remaining metadata keys become `key=value` pairs (exclude handler and the extracted ID key)
4. Level should be uppercase and padded to 5 chars: `INFO `, `WARN `, `ERROR`
5. Output to stdout via console.log (not console.error for errors -- all to stdout so Docker captures uniformly)

Example outputs:
- `2026-02-08T14:32:01.123Z INFO  web-gateway /api/orders req=abc123 product_id=5 quantity=2 Order created`
- `2026-02-08T14:32:02.456Z ERROR web-gateway /api/orders req=xyz789 timeout=5000ms Upstream timeout after 5000ms`
- `2026-02-08T14:32:03.789Z WARN  web-gateway RedisClient key=orders:5 Redis not connected, cache miss`

Keep the `info()`, `warn()`, `error()` convenience functions.
  </action>
  <verify>
Read logger.js and confirm:
- No JSON.stringify calls
- Output format matches `timestamp LEVEL service handler id details message`
- All output goes to console.log (stdout)
  </verify>
  <done>logger.js outputs plain text in the specified format with handler/ID extraction from metadata</done>
</task>

<task type="auto">
  <name>Task 2: Update all callers with handler metadata and add realistic error patterns</name>
  <files>
    services/web-gateway/src/server.js
    services/web-gateway/src/routes.js
    services/web-gateway/src/grpc-client.js
    services/web-gateway/src/redis-client.js
  </files>
  <action>
Update all logger calls across web-gateway source files to include a `handler` field identifying the specific handler/component. Also add occasional realistic error simulation.

**routes.js** - Update all logger calls to use `handler` instead of relying on implicit context:
- POST /orders handlers: `handler: '/api/orders'`
- GET /orders/:id handlers: `handler: '/api/orders/:id'`
- GET /orders handlers: `handler: '/api/orders'`
- Use `correlation_id` as the ID field (already present in most calls)

Add realistic error simulation in POST /orders:
- ~5% chance of simulated upstream timeout: before calling grpcClient.createOrder, check `Math.random() < 0.05`. If true, log a WARN about slow upstream, add a 100ms delay (setTimeout), then proceed normally. This gives the learner timeout warnings to find without actually breaking functionality.
- ~3% chance of logging a WARN about request body validation edge case (e.g., "Large quantity detected, may cause fulfillment delay" when quantity > 50)

**server.js** - Update request logging middleware:
- Use `handler: 'RequestMiddleware'` for the request/response logging
- Keep correlation ID propagation as-is

**grpc-client.js** - Update handler fields:
- Use `handler: 'gRPC:CreateOrder'`, `handler: 'gRPC:GetOrder'`, `handler: 'gRPC:ListOrders'` as appropriate
- Add ~2% chance of logging WARN "gRPC channel reconnecting" on any call (just a log, no actual failure)

**redis-client.js** - Update handler fields:
- Use `handler: 'RedisClient'` for all Redis operations
- Existing error handling already produces realistic WARN/ERROR logs -- keep those

Important: Do NOT break any existing functionality. Error simulation is log-only -- the actual request processing continues normally. These are cosmetic warnings that make logs realistic, not actual failures.
  </action>
  <verify>
Run: `grep -r "handler:" services/web-gateway/src/ | head -20` to confirm handler fields are present.
Run: `grep -r "Math.random" services/web-gateway/src/` to confirm error simulation is added.
Run: `grep -r "JSON.stringify" services/web-gateway/src/logger.js` returns no results (no JSON output).
  </verify>
  <done>All web-gateway logger calls include handler metadata, and routes.js includes realistic WARN/ERROR simulation (~5% timeout warnings, ~3% validation edge cases, ~2% gRPC reconnection warnings)</done>
</task>

</tasks>

<verification>
1. Read logger.js -- confirm plain text format, no JSON
2. Grep for `handler:` across all web-gateway src files -- every logger call should have it
3. Grep for `Math.random` -- confirm realistic error patterns exist
4. The logger API (info/warn/error with message + metadata object) remains backward compatible
</verification>

<success_criteria>
- web-gateway logger outputs plain text in format: `timestamp LEVEL web-gateway handler id details message`
- All callers include `handler` metadata field
- Realistic WARN/ERROR simulation produces occasional log entries during normal traffic
- No JSON output from logger
- Service functionality unchanged (error simulation is log-only)
</success_criteria>

<output>
After completion, create `.planning/phases/03-centralized-logging/03-01-SUMMARY.md`
</output>

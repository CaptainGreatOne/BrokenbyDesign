---
phase: 02-metrics-dashboards
plan: 03
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified:
  - prometheus/prometheus.yml
  - docker-compose.yml
autonomous: true

must_haves:
  truths:
    - "Prometheus scrapes metrics from web-gateway, order-api, and fulfillment-worker"
    - "Prometheus scrapes container metrics from cAdvisor"
    - "Prometheus scrapes host metrics from Node Exporter"
    - "Prometheus itself is accessible on port 9090"
    - "cAdvisor is accessible on port 8081 (remapped to avoid fulfillment-worker conflict)"
    - "All scrape targets show UP status in Prometheus targets page"
    - "Prometheus has healthcheck for downstream depends_on"
  artifacts:
    - path: "prometheus/prometheus.yml"
      provides: "Scrape configuration for all targets"
      contains: "scrape_configs"
    - path: "docker-compose.yml"
      provides: "prometheus, cadvisor, node-exporter service definitions with healthchecks"
      contains: "prom/prometheus"
  key_links:
    - from: "prometheus/prometheus.yml"
      to: "web-gateway:3000/metrics"
      via: "static_configs target"
      pattern: "web-gateway:3000"
    - from: "prometheus/prometheus.yml"
      to: "order-api:8000/metrics"
      via: "static_configs target"
      pattern: "order-api:8000"
    - from: "prometheus/prometheus.yml"
      to: "fulfillment-worker:2112/metrics"
      via: "static_configs target"
      pattern: "fulfillment-worker:2112"
    - from: "docker-compose.yml"
      to: "prometheus/prometheus.yml"
      via: "volume mount"
      pattern: "prometheus.yml:/etc/prometheus/prometheus.yml"
---

<objective>
Deploy Prometheus, cAdvisor, and Node Exporter as Docker Compose services, with Prometheus configured to scrape all application services and infrastructure exporters.

Purpose: Prometheus is the central metrics collection engine. Without it running and scraping, there are no metrics to visualize. cAdvisor and Node Exporter provide container and host-level metrics respectively.
Output: Running Prometheus instance scraping 6 targets (3 apps + prometheus self + cAdvisor + node-exporter), plus working cAdvisor and Node Exporter containers.
</objective>

<execution_context>
@/home/user/.claude/get-shit-done/workflows/execute-plan.md
@/home/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-metrics-dashboards/02-RESEARCH.md
@.planning/phases/02-metrics-dashboards/02-01-SUMMARY.md
@.planning/phases/02-metrics-dashboards/02-02-SUMMARY.md

# Existing compose file to modify
@docker-compose.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Prometheus configuration and add to Docker Compose</name>
  <files>
    prometheus/prometheus.yml
    docker-compose.yml
  </files>
  <action>
1. Create directory `prometheus/` at project root.

2. Create `prometheus/prometheus.yml` with:
   ```yaml
   global:
     scrape_interval: 15s
     evaluation_interval: 15s

   scrape_configs:
     - job_name: 'prometheus'
       static_configs:
         - targets: ['localhost:9090']

     - job_name: 'web-gateway'
       static_configs:
         - targets: ['web-gateway:3000']
       metrics_path: '/metrics'

     - job_name: 'order-api'
       static_configs:
         - targets: ['order-api:8000']
       metrics_path: '/metrics'

     - job_name: 'fulfillment-worker'
       static_configs:
         - targets: ['fulfillment-worker:2112']
       metrics_path: '/metrics'

     - job_name: 'cadvisor'
       static_configs:
         - targets: ['cadvisor:8080']
       scrape_interval: 10s

     - job_name: 'node-exporter'
       static_configs:
         - targets: ['node-exporter:9100']
   ```

3. Add the following services to `docker-compose.yml`:

   **prometheus:**
   - image: `prom/prometheus:v3.5.1`
   - container_name: prometheus
   - volumes: `./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro`
   - command: `--config.file=/etc/prometheus/prometheus.yml --storage.tsdb.retention.time=7d --storage.tsdb.retention.size=5GB --web.enable-lifecycle`
   - ports: `9090:9090`
   - depends_on: web-gateway, order-api, fulfillment-worker (condition: service_healthy for web-gateway; service_started for order-api and fulfillment-worker since they don't have HTTP healthchecks yet)
   - healthcheck: `test: ["CMD-SHELL", "wget --spider -q http://localhost:9090/-/ready || exit 1"]`, interval: 5s, timeout: 3s, retries: 5, start_period: 15s
   - restart: unless-stopped
   - deploy resources: memory limit 1G, cpus 1.0, memory reservation 512M, cpus 0.5
   - logging: json-file, max-size 10m, max-file 3
   - Add `prometheus-data` to the volumes section at the bottom (alongside existing postgres-data)
   - Mount: `prometheus-data:/prometheus`

   **cadvisor:**
   - image: `gcr.io/cadvisor/cadvisor:latest`
   - container_name: cadvisor
   - privileged: true
   - devices: `/dev/kmsg:/dev/kmsg`
   - volumes: `/:/rootfs:ro`, `/var/run:/var/run:ro`, `/sys:/sys:ro`, `/var/lib/docker/:/var/lib/docker:ro`, `/dev/disk/:/dev/disk:ro`
   - ports: `8081:8080` (NOTE: map to 8081 on host because cAdvisor uses 8080 internally, and we want to avoid confusion; fulfillment-worker does NOT expose 2112 on host currently, but clarity is good)
   - restart: unless-stopped
   - deploy resources: memory limit 200M, cpus 0.5
   - logging: json-file, max-size 10m, max-file 3

   **node-exporter:**
   - image: `prom/node-exporter:latest`
   - container_name: node-exporter
   - command: `--path.rootfs=/host`
   - pid: host
   - volumes: `/:/host:ro,rslave`
   - ports: `9100:9100`
   - restart: unless-stopped
   - deploy resources: memory limit 100M, cpus 0.25
   - logging: json-file, max-size 10m, max-file 3

   NOTE on node-exporter: Do NOT use `network_mode: host` because it breaks Docker Compose DNS resolution. Prometheus scrapes node-exporter by container name, which only works on the default bridge network. Instead, mount the host filesystem and use the `--path.rootfs=/host` flag. Map port 9100 explicitly.

4. Update the resource budget comment at the top of docker-compose.yml to reflect new totals:
   - Core services: ~5GB (unchanged)
   - Observability: Prometheus ~1GB + cAdvisor ~200MB + Node Exporter ~100MB = ~1.3GB
   - Total: ~6.3GB (within 12GB budget)

IMPORTANT: Do NOT remove or modify any existing service definitions. Only ADD the three new services and the prometheus-data volume.

IMPORTANT: For Prometheus depends_on, use `service_started` (not `service_healthy`) for order-api and fulfillment-worker since they lack HTTP-based healthchecks. The order-api healthcheck tests the gRPC port, not the metrics port. Prometheus will retry scraping automatically.
  </action>
  <verify>
Run `docker compose config` from the project root to validate the compose file syntax. Verify prometheus/prometheus.yml exists with 6 scrape jobs. Verify docker-compose.yml has prometheus, cadvisor, and node-exporter services. Verify prometheus-data volume is defined.
  </verify>
  <done>
prometheus/prometheus.yml exists with scrape configs for prometheus, web-gateway, order-api, fulfillment-worker, cadvisor, and node-exporter. docker-compose.yml includes prometheus (port 9090), cadvisor (port 8081), and node-exporter (port 9100) services with healthchecks, resource limits, and logging. prometheus-data volume defined. Compose file validates with `docker compose config`.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update order-api and fulfillment-worker healthchecks for metrics ports</name>
  <files>
    docker-compose.yml
  </files>
  <action>
1. The order-api currently only has a healthcheck that tests the gRPC port (50051). Since we added a metrics HTTP server on port 8000, we should NOT change the existing healthcheck (gRPC readiness is what matters for service health). However, we need to ensure Prometheus can reach port 8000 inside the container.

   Verify that the order-api Dockerfile EXPOSEs port 8000. If it only exposes 50051, add EXPOSE 8000 to the Dockerfile. No port mapping to host is needed -- Prometheus connects via Docker network.

2. The fulfillment-worker currently has NO healthcheck in docker-compose.yml. Now that it has an HTTP server on port 2112, add a healthcheck:
   ```yaml
   healthcheck:
     test: ["CMD-SHELL", "wget -qO- http://localhost:2112/health || exit 1"]
     interval: 5s
     timeout: 3s
     retries: 3
     start_period: 10s
   ```
   This tests the /health endpoint on the metrics server we added in Plan 02.

3. Update the Prometheus depends_on for fulfillment-worker to use `condition: service_healthy` (since it now has a healthcheck).

4. Verify order-api and fulfillment-worker services in docker-compose.yml are complete and consistent with all other services.

NOTE: Do NOT expose the metrics ports to the host (no port mapping for 8000 or 2112). Prometheus accesses them via the Docker internal network. Only Prometheus, Grafana, cAdvisor, and Node Exporter need host port mappings.
  </action>
  <verify>
Run `docker compose config` to validate. Check that fulfillment-worker has a healthcheck defined. Check that order-api Dockerfile includes EXPOSE 8000. Verify Prometheus depends_on includes fulfillment-worker with service_healthy condition.
  </verify>
  <done>
fulfillment-worker has HTTP-based healthcheck on port 2112. order-api Dockerfile exposes port 8000 for metrics. Prometheus depends_on uses service_healthy for services with HTTP healthchecks. Compose file validates cleanly.
  </done>
</task>

</tasks>

<verification>
1. `docker compose config` validates without errors
2. prometheus/prometheus.yml has 6 scrape jobs
3. docker-compose.yml has prometheus, cadvisor, node-exporter services
4. All new services have resource limits, logging, and restart policies
5. fulfillment-worker has healthcheck on metrics port
6. prometheus-data volume is defined
</verification>

<success_criteria>
- Prometheus configured to scrape all 3 application services + cAdvisor + Node Exporter + itself
- cAdvisor has host filesystem mounts for container metrics
- Node Exporter has host filesystem mount for system metrics
- Resource budget stays within 12GB (new total ~6.3GB)
- All services follow existing conventions (resource limits, logging rotation, restart policy)
</success_criteria>

<output>
After completion, create `.planning/phases/02-metrics-dashboards/02-03-SUMMARY.md`
</output>
